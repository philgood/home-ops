---
# Webhook hooks configuration for AlertManager â†’ Home Assistant
- id: "alertmanager"
  execute-command: "/bin/sh"
  command-working-directory: "/tmp"
  pass-arguments-to-command:
    - source: "string"
      name: "-c"
    - source: "string"
      name: |
        PAYLOAD="$1"
        HA_URL="https://hass.narden.au/api/webhook/k8s_temp_a7f3c9e2b4d1a"
        
        # Extract fields using sed
        STATUS=$(echo "$PAYLOAD" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p' | head -1)
        ALERTNAME=$(echo "$PAYLOAD" | sed -n 's/.*"alertname":"\([^"]*\)".*/\1/p' | head -1)
        DESCRIPTION=$(echo "$PAYLOAD" | sed -n 's/.*"description":"\([^"]*\)".*/\1/p' | head -1)
        
        # Build JSON inline
        HA_PAYLOAD="{\"title\":\"${ALERTNAME:-K8s Alert}\",\"body\":\"${DESCRIPTION:-Temperature alert}\",\"status\":\"${STATUS:-firing}\"}"
        
        # Debug
        echo "Sending: $HA_PAYLOAD"
        
        # Send to Home Assistant with curl (pass data inline, not from file)
        echo "$HA_PAYLOAD" | curl -X POST -m 3 -s \
          -H "Content-Type: application/json" \
          -d @- \
          "$HA_URL" || echo "curl failed" >&2
        
        echo "Done: ${ALERTNAME:-Unknown} (${STATUS:-unknown})"
    - source: "entire-payload"
  response-message: "Alert forwarded"