---
# Webhook hooks configuration for AlertManager â†’ Home Assistant
- id: "alertmanager"
  execute-command: "/bin/sh"
  command-working-directory: "/tmp"
  pass-arguments-to-command:
    - source: "string"
      name: "-c"
    - source: "string"
      name: |
        PAYLOAD="$1"
        HA_URL="https://hass.narden.au/api/webhook/k8s_temp_a7f3c9e2b4d1a"
        
        # Simple extraction without complex regex - just get the first occurrence
        STATUS=$(echo "$PAYLOAD" | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4)
        ALERTNAME=$(echo "$PAYLOAD" | grep -o '"alertname":"[^"]*"' | head -1 | cut -d'"' -f4)
        DESCRIPTION=$(echo "$PAYLOAD" | grep -o '"description":"[^"]*"' | head -1 | cut -d'"' -f4)
        
        # Fallback values if extraction failed
        STATUS="${STATUS:-firing}"
        ALERTNAME="${ALERTNAME:-K8s Alert}"
        DESCRIPTION="${DESCRIPTION:-Temperature alert}"
        
        # Build JSON
        HA_PAYLOAD="{\"title\":\"$ALERTNAME\",\"body\":\"$DESCRIPTION\",\"status\":\"$STATUS\"}"
        
        # Debug
        echo "Alert: $ALERTNAME | Status: $STATUS"
        
        # Send to Home Assistant
        echo "$HA_PAYLOAD" | curl -X POST -m 3 -s \
          -H "Content-Type: application/json" \
          -d @- \
          "$HA_URL" || echo "curl failed" >&2
        
        echo "Sent to HA"
    - source: "entire-payload"
  response-message: "Alert forwarded"