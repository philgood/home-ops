---
# Webhook hooks configuration for AlertManager â†’ Home Assistant
- id: "alertmanager"
  execute-command: "/bin/sh"
  command-working-directory: "/tmp"
  pass-arguments-to-command:
    - source: "string"
      name: "-c"
    - source: "string"
      name: |
        PAYLOAD="$1"
        HA_URL="https://hass.narden.au/api/webhook/k8s_temp_a7f3c9e2b4d1a"
        
        # Extract fields using sed (more reliable than grep in busybox)
        STATUS=$(echo "$PAYLOAD" | sed -n 's/.*"status":"\([^"]*\)".*/\1/p' | head -1)
        ALERTNAME=$(echo "$PAYLOAD" | sed -n 's/.*"alertname":"\([^"]*\)".*/\1/p' | head -1)
        DESCRIPTION=$(echo "$PAYLOAD" | sed -n 's/.*"description":"\([^"]*\)".*/\1/p' | head -1)
        
        # Build simplified payload for Home Assistant
        cat > /tmp/ha_payload.json <<EOF
        {"title":"${ALERTNAME:-K8s Alert}","body":"${DESCRIPTION:-Temperature alert}","status":"${STATUS:-firing}"}
        EOF
        
        # Send to Home Assistant
        wget -q -O- \
          --header="Content-Type: application/json" \
          --post-file=/tmp/ha_payload.json \
          "$HA_URL" 2>&1 || echo "Failed" >&2
        
        echo "Sent: ${ALERTNAME:-Unknown} (${STATUS:-unknown})"
    - source: "entire-payload"
  response-message: "Alert forwarded to Home Assistant"